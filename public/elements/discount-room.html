<link rel="import" href="../../bower_components/polymer/polymer.html">

<polymer-element 	name="discount-room" 
					on-new-char="{{ newCharHandler }}"
					on-moved-user="{{ movedUserHandler }}"
					on-data-change="{{ dataChange }}"
					on-user-left="{{ userExitHandler }}">
	<template>
		<style type="text/css">
			/* Elements */

			label {
				display: inline-block;
				text-align: right;
				width: 8.75em;
			}

			table {
				font-size: 8pt;
				height:100%;
				padding-left: auto;
				padding-right: auto;
				width:100%;
			}

			td {
				height: 2.2em;
				text-align: center;
				vertical-align: bottom;	
				width: 1.25%;
			}

			/* Classes */

			.possiblechar {
				border: 1px solid black;
			}

			.selected {
				border: 1px solid white;
			}

			.singlecolor {
				display: inline-block;
				height: 24px;
				margin-right: 6px;
				opacity: 0.9;
				transition: opacity 1s;
				-webkit-transition: opacity 1s;
				-moz-transition: opacity 1s;
				-o-transition: opacity 1s;
				width: 24px;
			}

			/* IDs */

			#buttoncontainer {
				display:inline-block;
				margin-left: 9.2em;
				margin-top: 0.5em;
			}

			#charblock {
				display:inline-block;
				padding-bottom:6px;
				vertical-align: text-top;
				width: 32em;
			}

			#colorblock {
				display:inline-block;
				vertical-align: text-top;
				width: 32em;
			}

			#submit {
				display:inline-block;
			}

			#userconfig {
				display: block;
			} 
		</style>
			<div id="userconfig">
				<label>Name:</label> 
				<input id="uname" type="text"></input><br>
				<label>Character:</label>
				<div id="charblock">
					<template repeat="{{ char in characters }}">
						<span id="{{char.name}}" class="possiblechar" on-click={{clickChar}}>{{char.chr}}</span>
					</template>
				</div><br>
				<label>Color:</label>
				<div id="colorblock">
					<template repeat="{{ color in palette }}">
						<div class="singlecolor" id="{{color}}" on-click={{fadeOthers}}></div>
					</template>
				</div>
				<br>
				<div id="buttoncontainer">
					<button id="submit" on-click={{sendChar}}>Submit</button>
				</div>
			</div>
			<hr>
			<table> 
	        	<template repeat="{{ file in files }}">
	        	    <tr>
	        	        <template repeat="{{ rank in ranks }}">
	        	            <td id="{{file}}{{rank}}">{{ space }}</td>
	        	        </template>
	    	        </tr>
	    	    </template>
		    </table>
	</template>
	<script src="/socket.io/socket.io.js"></script>
	<script>
		var socket = io();

		Polymer('discount-room', {
			publish: {
				user: null
			},
			readyFlag: 0,
			characters: [
				{name:"a", chr:"a"}, 
				{name:"b", chr:"b"}, 
				{name:"c", chr:"c"}, 
				{name:"d", chr:"d"}, 
				{name:"e", chr:"e"}, 
				{name:"f", chr:"f"}, 
				{name:"g", chr:"g"}, 
				{name:"h", chr:"h"}, 
				{name:"i", chr:"i"}, 
				{name:"j", chr:"j"}, 
				{name:"k", chr:"k"}, 
				{name:"l", chr:"l"}, 
				{name:"m", chr:"m"}, 
				{name:"n", chr:"n"}, 
				{name:"o", chr:"o"}, 
				{name:"p", chr:"p"}, 
				{name:"q", chr:"q"}, 
				{name:"r", chr:"r"}, 
				{name:"s", chr:"s"}, 
				{name:"t", chr:"t"}, 
				{name:"u", chr:"u"}, 
				{name:"v", chr:"v"}, 
				{name:"w", chr:"w"}, 
				{name:"x", chr:"x"}, 
				{name:"y", chr:"y"}, 
				{name:"z", chr:"z"}, 
				{name:"A", chr:"A"}, 
				{name:"B", chr:"B"}, 
				{name:"C", chr:"C"}, 
				{name:"D", chr:"D"}, 
				{name:"E", chr:"E"}, 
				{name:"F", chr:"F"}, 
				{name:"G", chr:"G"}, 
				{name:"H", chr:"H"}, 
				{name:"I", chr:"I"}, 
				{name:"J", chr:"J"}, 
				{name:"K", chr:"K"}, 
				{name:"L", chr:"L"}, 
				{name:"M", chr:"M"}, 
				{name:"N", chr:"N"}, 
				{name:"O", chr:"O"}, 
				{name:"P", chr:"P"}, 
				{name:"Q", chr:"Q"}, 
				{name:"R", chr:"R"}, 
				{name:"S", chr:"S"}, 
				{name:"T", chr:"T"}, 
				{name:"U", chr:"U"}, 
				{name:"V", chr:"V"}, 
				{name:"W", chr:"W"}, 
				{name:"X", chr:"X"}, 
				{name:"Y", chr:"Y"}, 
				{name:"Z", chr:"Z"}, 
				{name:"zero", chr:"0"}, 
				{name:"one", chr:"1"}, 
				{name:"two", chr:"2"}, 
				{name:"three", chr:"3"}, 
				{name:"four", chr:"4"}, 
				{name:"five", chr:"5"}, 
				{name:"six", chr:"6"}, 
				{name:"seven", chr:"7"}, 
				{name:"eight", chr:"8"}, 
				{name:"nine", chr:"9"}, 
				{name:"colon", chr:":"},
				{name:"doublequote", chr: "\""}, 
				{name:"hash", chr: "#"}, 
				{name:"percent", chr:"%"}, 
				{name:"ampersand", chr: "&"}, 
				{name:"singlequote", chr:"\'"}, 
				{name:"openbracket", chr:"("}, 
				{name:"closebracket", chr:")"}, 
				{name:"asterisk", chr:"*"}, 
				{name:"plus", chr:"+"}, 
				{name:"comma", chr:","}, 
				{name:"hyphen", chr:"-"}, 
				{name:"period", chr:"."}, 
				{name:"slash", chr:"/"}, 
				{name:"semicolon", chr:";"}, 
				{name:"openanglebracket", chr:"<"}, 
				{name:"equals", chr:"="}, 
				{name:"closeanglebracket", chr:">"}, 
				{name:"question", chr:"?"}, 
				{name:"at", chr:"@"}, 
				{name:"opensquarebracket", chr:"["}, 
				{name:"backslash", chr:"\\"}, 
				{name:"closesquarebracket", chr:"]"}, 
				{name:"caret", chr:"^"}, 
				{name:"underscore", chr:"_"}, 
				{name:"accent", chr:"`"}, 
				{name:"opencurlybrace", chr:"{"}, 
				{name:"pipe", chr:"|"}, 
				{name:"closecurlybrace", chr:"}"}, 
				{name:"tilde", chr:"~"}
			],
			charlist: [],
			palette: [
				"red", 
				"yellow", 
				"green", 
				"blue", 
				"cyan", 
				"purple", 
				"brown", 
				"fuchsia", 
				"greenyellow", 
				"orange", 
				"white", 
				"gray"
			],
			selectedChar: "",
			selectedColor: "",
			ranks: [],
			files: [
				"a",
				"b",
				"c",
				"d",
				"e",
				"f",
				"g",
				"h",
				"i",
				"j",
				"k",
				"l",
				"m",
				"n",
				"o",
				"p",
				"q",
				"r",
				"s",
				"t",
				"u",
				"v",
				"w",
				"x"
			],
			newfileup: 0,
			newfiledown: 0,
			newrankleft: 0,
			newrankright: 0,
			occupied: {},
			space: " ",

			ready: function (){
				for (i = 0; i < 80; i++) {
					this.ranks.push(i);
				}
				for (var i = 0; i < this.characters.length; i++) {
					this.charlist.push(this.characters[i].chr);
				}
				this.styleColorDivs();
				var boundOnKeyUp = this.onKeyUp.bind(this);
				window.addEventListener("keyup", boundOnKeyUp, false);
				setInterval(this.screenScrub(), 3000);
				this.readyFlag = 1;
			},

			styleColorDivs: function(){
				var queryRoot = this.shadowRoot;
				var resource = this.palette;
				for (var h = 0; h < this.palette.length; h++) {
					queryRoot.getElementById(resource[h]).style.background=resource[h];
					queryRoot.getElementById(resource[h]).style.opacity=0.9;
				} 
			},

			screenScrub: function() {
				if (this.readyFlag) {
					for (var i = 0; i < this.files.length; i++) {
						for (var j = 0; j < this.ranks.length; j++) {
							var scrub = this.files[i] + this.ranks[j];
							if (!this.occupied.hasOwnProperty(scrub)) {
								this.shadowRoot.getElementById(scrub).innerHTML = this.space;
							}
						}
					}
				}
			},

			userChanged: function(){
				console.log('you have been assigned user ID ' + this.user);
				this.$.userconfig.style.display="block";
			},

			clickChar: function(el) {
				if (el.toElement.className == "possiblechar selected") {
					return false;
				} else {
					var clickedId = "#" + el.toElement.id;
					var queried = this.shadowRoot;
					var resource = this.characters;
					var preselect = "";
					for (var i = 0; i < resource.length; i++) {
						var itr = "#" + resource[i].name;
						queried.querySelector(itr).className = "possiblechar";
					}
					var clicked = this.shadowRoot.querySelector(clickedId);
					clicked.className = clicked.className + " selected";
					var slicedId = clickedId.substring(1);
					for (var j = 0; j < resource.length; j++) {
						if (resource[j].name == slicedId) {
							preselect = resource[j].chr;
						}
					}
					this.selectedChar = preselect;
				}
			},

			fadeOthers: function(e){
				var resource = this.palette;
				for (var k = 0; k < this.palette.length; k++){
					this.shadowRoot.getElementById(this.palette[k]).style.opacity=0.3;
				}
				this.shadowRoot.getElementById(e.toElement.id).style.opacity=1;
				this.selectedColor = e.toElement.id;
			},

			sendChar: function(){
				var unm = this.$.uname.value;
				var uchr = this.selectedChar;
				var uclr = this.selectedColor; 
				var uid = this.user;
				if (uchr == "" || unm == "" || uclr == "") {
					alert("Need a name, character and color");
					return false;
				} else {
					var startplace = this.randomPlace();
					var startfile = startplace.substring(0,1);
					var startrank = startplace.substring(1);

					this.userState = {
						id: uid,
						rank: startrank,
						file: startfile,
						chr: uchr,
						clr: uclr,
						nm: unm,
						lastknownplace: ""
					};

					socket.emit('newChar', this.userState);
				}
				this.shadowRoot.querySelector("#userconfig").style.display="none";
			},

			randomPlace: function() {
				var file = this.files[Math.floor(Math.random() * (this.files.length - 1))];
				var rank = Math.floor(Math.random()*(this.ranks.length -1));
				var place = file + rank;
				if (this.occupied.hasOwnProperty(place)) {
					this.randomPlace();
				} else {
					return place;
				}
			},

			newCharHandler: function(payload){
				var list = payload.detail;
				for (var coords in list) {
					if (list[coords] == this.user) {
						if (!this.occupied.hasOwnProperty(coords)) {
							var newNode = this.shadowRoot.getElementById(coords);
							var lchr = this.userState.chr;
							var lclr = this.userState.clr;
							newNode.innerHTML = lchr;
							newNode.style.color = lclr;
							this.occupied[coords] = {
								nm: list[coords],
								chr: lchr,
								clr: lclr
							};
							console.log("user " + list[coords] + " has entered the room at " + coords);
						}
					} else {
						if (!this.occupied.hasOwnProperty(coords)) {
							var newNode = this.shadowRoot.getElementById(coords);
							var rchr = this.randomChar();
							var rclr = this.randomColor();
							newNode.innerHTML = rchr;
							newNode.style.color = rclr;
							this.occupied[coords] = {
								nm: list[coords],
								chr: rchr,
								clr: rclr
							};
							console.log("user " + list[coords] + " has entered the room at " + coords);
						}
					}			
				}
				this.fire('data-change');
			},

			randomChar: function(){
				return this.charlist[Math.floor(Math.random() * (this.charlist.length - 1))];
			},

			randomColor: function(){
				return this.palette[Math.floor(Math.random() * (this.palette.length - 1))];
			},

			onKeyUp: function (evt) {
				if (evt = evt ? evt : window.event ? event : null) {
					if (this[evt.keyCode]) {
						this[evt.keyCode](evt);
					}
				}
			},

			'37': function(evt){
				if (this.userState.rank === 0) {
					return false;
				}
				var oldplace = this.userState.file + this.userState.rank;
				this.userState.lastknownplace = oldplace;
				var newplace = this.userState.file + this.newrankleft;
				if (this.noCollision(newplace)) {
					this.userState.rank = this.newrankleft;
					var movePayload = [this.userState.id, newplace];
					socket.emit('userMoved', movePayload);
				}
			},
			'38': function(evt){
				if (this.userState.file === 'a') {
					return false;
				}
				var oldplace = this.userState.file + this.userState.rank;
				this.userState.lastknownplace = oldplace;
				var newplace = this.files[this.newfileup] + this.userState.rank;
				if (this.noCollision(newplace)) {
					this.userState.file = this.files[this.newfileup];
					var movePayload = [this.userState.id, newplace];
					socket.emit('userMoved', movePayload);
				}
			},
			'39': function(evt){
				if (this.userState.rank === 79) {
					return false;
				}
				var oldplace = this.userState.file + this.userState.rank;
				this.userState.lastknownplace = oldplace;
				var newplace = this.userState.file + this.newrankright;
				if (this.noCollision(newplace)) {
					this.userState.rank = this.newrankright;
					var movePayload = [this.userState.id, newplace];
					socket.emit('userMoved', movePayload);
				}
			},
			'40': function(evt){
				if (this.userState.file === 'x') {
					return false;
				}
				var oldplace = this.userState.file + this.userState.rank;
				this.userState.lastknownplace = oldplace;
				var newplace = this.files[this.newfiledown] + this.userState.rank;
				if (this.noCollision(newplace)) {
					this.userState.file = this.files[this.newfiledown];
					var movePayload = [this.userState.id, newplace];
					socket.emit('userMoved', movePayload);
				}
			},
			'192': function(evt){
				if (evt.ctrlKey && evt.shiftKey) {
					if (this.debug) {
						this.debug = 0;
						console.log('debug mode off');
					} else {
						this.debug = 1;
						console.log('debug mode on');
					}
				}
			},

			noCollision: function(newplace) {
				if (!this.occupied.hasOwnProperty(newplace)) {
					return true;
				} else {
					return false;
				}
			},

			// when extending to multiplayer roguelike: 
			//		add function here to do combat
			//		called from keyhandler when noCollision returns false.

			movedUserHandler: function(resPayload){
				var res = resPayload.detail;
				var mid = res[0];
				var oldplace = res[1];
				var newplace = res[2];
				var newcoords = this.occupied[oldplace];
				if (newcoords.nm == mid) {
					var mchr = newcoords.chr;
					var mclr = newcoords.clr;
					delete this.occupied[oldplace];
					this.occupied[newplace] = newcoords;
					this.moveUpdate(oldplace, newplace, mchr, mclr);
				}
			},

			moveUpdate: function(oldplace, newplace, chr, clr) {
				this.shadowRoot.getElementById(oldplace).innerHTML = this.space;
				this.shadowRoot.getElementById(newplace).innerHTML = chr;
				this.shadowRoot.getElementById(newplace).style.color = clr;
				this.fire('data-change');
			},

			dataChange: function() {
				if (this.user == null) {
					console.log("you are not yet in the room");
				} else {
					if (this.userState) {
						var place = this.userState.file + this.userState.rank;
						console.log("your position is " + place);
						var filenum = this.files.indexOf(this.userState.file)
						this.newfiledown = filenum;
						this.newfiledown++;
						this.newfileup = filenum;
						this.newfileup--;
						this.newrankleft = this.userState.rank;
						this.newrankleft--;
						this.newrankright = this.userState.rank;
						this.newrankright++;
					}
				}
			},			

			userExitHandler: function(payload){
				var place = payload.detail;
				var lnm = this.occupied[place].nm;
				delete this.occupied[place];
				this.shadowRoot.getElementById(place).innerHTML = this.space;
				console.log("user " + lnm + " has left the room");
			}
		});		
	</script>
</polymer-element>